<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Resultado do Sorteio</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    body {
      background-color: #FFCC29;
    }
    .header {
      background-color: #FFCC29;
      color: #003399;
      text-align: center;
      padding: 20px;
      border-bottom: 4px solid #003399;
    }
    .section-divider {
      border-top: 4px solid #003399;
      margin: 40px 0 20px;
    }
    .table th {
      background-color: #003399;
      color: white;
    }
    .posicao {
      font-weight: bold;
    }
    .jogador {
      cursor: move;
    }
    .jogador:hover {
      background-color: #fff8dc;
    }
    .titulo-centralizado {
      text-align: center;
      color: #003399;
      font-weight: bold;
    }
    .pdf-salvar-btn {
      margin: 10px;
    }
        @media print {
      /* Oculta botões e controles */
      .pdf-salvar-btn,
      .text-center.my-4,
      .btn,
      a[href],
      button {
        display: none !important;
      }

      /* Remove margens de tela e deixa mais limpo para PDF */
      body {
        background-color: white !important;
      }

      .header {
        border: none;
      }

      /* Evita quebra de página dentro das tabelas */
      table, tr, td, th {
        page-break-inside: avoid !important;
      }
    }
  </style>
<script>
  function allowDrop(ev) {
    ev.preventDefault();
  }

  function drag(ev) {
    ev.dataTransfer.setData("text", ev.target.id);
  }

  function drop(ev, targetId) {
    ev.preventDefault();
    var data = ev.dataTransfer.getData("text");
    var dragged = document.getElementById(data);
    var target = document.getElementById(targetId);

    if (!dragged || !target) return;

    var nome1 = dragged.querySelector(".nome").textContent;
    var pontos1 = dragged.querySelector(".pontos").textContent;
    var nome2 = target.querySelector(".nome").textContent;
    var pontos2 = target.querySelector(".pontos").textContent;

    dragged.querySelector(".nome").textContent = nome2;
    dragged.querySelector(".pontos").textContent = pontos2;
    target.querySelector(".nome").textContent = nome1;
    target.querySelector(".pontos").textContent = pontos1;

    var draggedRow = dragged.closest("tr");
    var targetRow = target.closest("tr");

    if (dragged.cellIndex === 0 && target.cellIndex === 3) {
      draggedRow.children[1].textContent = pontos2;
      targetRow.children[4].textContent = pontos1;
    } else if (dragged.cellIndex === 3 && target.cellIndex === 0) {
      draggedRow.children[4].textContent = pontos2;
      targetRow.children[1].textContent = pontos1;
    } else {
      if (dragged.cellIndex === 0) {
        draggedRow.children[1].textContent = pontos2;
        targetRow.children[1].textContent = pontos1;
      } else {
        draggedRow.children[4].textContent = pontos2;
        targetRow.children[4].textContent = pontos1;
      }
    }

    const jogoIndex = target.dataset.jogo;
    updateTotals(jogoIndex);
  }

  function updateTotals(jogoIndex) {
    let totalAzul = 0;
    let totalBranco = 0;

    document.querySelectorAll(`[data-jogo='${jogoIndex}'].azul .pontos`).forEach(span => {
      totalAzul += parseInt(span.textContent);
    });

    document.querySelectorAll(`[data-jogo='${jogoIndex}'].branco .pontos`).forEach(span => {
      totalBranco += parseInt(span.textContent);
    });

    document.getElementById(`total-azul-${jogoIndex}`).textContent = totalAzul;
    document.getElementById(`total-branco-${jogoIndex}`).textContent = totalBranco;
  }

  function gerarPDF() {
    // Oculta botões e cabeçalho
    document.querySelectorAll(".pdf-salvar-btn, .text-center.my-4, .btn, a[href], button, .header").forEach(el => {
      el.style.display = "none";
    });

    // Cria título simples com data
    const hoje = new Date();
    const data = hoje.toLocaleDateString('pt-BR');
    const titulo = document.createElement("h2");
    titulo.textContent = `Sorteio Peladeiros AABB Curitiba – ${data}`;
    titulo.style.textAlign = "center";
    titulo.style.marginTop = "10px";
    titulo.id = "titulo-pdf";
    document.body.insertBefore(titulo, document.body.firstChild);

    // Adiciona CSS para impressão em modo paisagem e controle de quebras
    const style = document.createElement("style");
    style.innerHTML = `
      @page { size: A4 landscape; margin: 10mm; }

      body { background: white !important; }

      /* Evita quebra entre títulos e suas seções */
      h2.titulo-centralizado, h3.text-center {
        page-break-after: avoid;
      }

      /* Quebra de página apenas antes do Jogo 2, Jogo 3, etc, e "Jogadores Restantes" */
      h3.text-center:not(:first-of-type),
      h2.titulo-centralizado:nth-of-type(3) {
        page-break-before: always;
      }

      /* Evita quebra dentro das tabelas */
      table, tr, td, th { page-break-inside: avoid !important; }
    `;
    document.head.appendChild(style);

    // Gera o PDF
    window.print();

    // Remove título e restaura elementos
    titulo.remove();
    document.querySelectorAll(".pdf-salvar-btn, .text-center.my-4, .btn, a[href], button, .header").forEach(el => {
      el.style.display = "";
    });
    style.remove();
  }
</script>

</head>
<body>
  <div class="header">
    <img src="{{ url_for('static', filename='logo.jpg') }}" alt="Peladeiros AABB Curitiba" style="max-width: 100px;">
    <h1 class="mt-2 mb-0">Peladeiros AABB Curitiba</h1>
    <p class="mb-0">Resultado do Sorteio</p>
  </div>

  <div class="container py-4">
    <h2 class="titulo-centralizado">Ordem do Sorteio Inicial</h2>
    <div class="row">
      {% for nome in ordem %}
        {% if loop.index0 % 16 == 0 %}<div class="col-md-3"><ol>{% endif %}
        <li>{{ nome }}</li>
        {% if loop.index0 % 16 == 15 or loop.last %}</ol></div>{% endif %}
      {% endfor %}
    </div>

    <div class="section-divider"></div>

    <h2 class="titulo-centralizado">Jogos Formados</h2>
    {% set posicoes_fixas = ['Zagueiro', 'Lateral 1', 'Lateral 2', 'Meio Campo 1', 'Meio Campo 2', 'Meio Campo 3', 'Atacante 1', 'Atacante 2'] %}
    {% for jogo in jogos %}
      {% set jogo_index = loop.index %}
      <h3 class="text-center">Jogo {{ jogo_index }}</h3>
      <table class="table table-bordered text-center" style="max-width: 800px; margin: auto;">
        <thead>
          <tr>
            <th>Time Azul</th><th>Pontos</th><th class="posicao">Posição</th><th>Time Branco</th><th>Pontos</th>
          </tr>
        </thead>
        <tbody>
        {% for posicao in posicoes_fixas %}
          {% set linha_index = loop.index0 %}
          {% set jogador_azul = (jogo.time_azul | selectattr('posicao', 'equalto', posicao) | list).0 %}
          {% set jogador_branco = (jogo.time_branco | selectattr('posicao', 'equalto', posicao) | list).0 %}
          <tr>
            <td id="azul-{{ jogo_index }}-{{ linha_index }}" data-jogo="{{ jogo_index }}" class="azul jogador" draggable="true" ondragstart="drag(event)" ondrop="drop(event, 'azul-{{ jogo_index }}-{{ linha_index }}')" ondragover="allowDrop(event)">
              <span class="nome">{{ jogador_azul.nome }}</span> <span class="pontos d-none">{{ jogador_azul.pontos }}</span>
            </td>
            <td>{{ jogador_azul.pontos }}</td>
            <td class="posicao">{{ posicao }}</td>
            <td id="branco-{{ jogo_index }}-{{ linha_index }}" data-jogo="{{ jogo_index }}" class="branco jogador" draggable="true" ondragstart="drag(event)" ondrop="drop(event, 'branco-{{ jogo_index }}-{{ linha_index }}')" ondragover="allowDrop(event)">
              <span class="nome">{{ jogador_branco.nome }}</span> <span class="pontos d-none">{{ jogador_branco.pontos }}</span>
            </td>
            <td>{{ jogador_branco.pontos }}</td>
          </tr>
        {% endfor %}
        <tr class="fw-bold bg-light">
          <td>Total</td>
          <td id="total-azul-{{ jogo_index }}">{{ jogo.total_azul }}</td>
          <td></td>
          <td>Total</td>
          <td id="total-branco-{{ jogo_index }}">{{ jogo.total_branco }}</td>
        </tr>
        </tbody>
      </table>
      <br>
    {% endfor %}

    <div class="section-divider"></div> <!-- Linha divisória adicionada -->

    <h2 class="titulo-centralizado">Jogadores Restantes</h2>
    <ol style="max-width:800px; margin:auto; text-align:left;">
      {% for j in jogadores_restantes %}
        <li>{{ j[1] }}</li>
      {% endfor %}
    </ol>



    <div class="text-center my-4">
      <a href="{{ url_for('adicionar_atrasado') }}" class="btn btn-primary">Adicionar Jogador Atrasado</a>
      <a href="{{ url_for('formar_proximo_jogo') }}" class="btn btn-primary">Formar Próximo Jogo</a>
      <a href="{{ url_for('index') }}" class="btn btn-primary">Retornar à Lista de Presença</a>
      <button onclick="gerarPDF()" class="btn btn-dark pdf-salvar-btn">Gerar PDF</button>
    </div>
  </div>
</body>
</html>



